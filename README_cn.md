# SYN 扫描器 - 异步TCP SYN端口扫描工具

*此代码创建于2019年学习zmap网络扫描技术期间。*

一个用Go语言编写的高性能异步TCP SYN端口扫描器，支持单个IP或CIDR网段扫描，具备速率限制和并发处理功能。

## 功能特性

- **异步SYN扫描**: 使用原始TCP SYN数据包进行快速端口检测
- **CIDR支持**: 支持单个IP或整个网段扫描（如 192.168.1.0/24）
- **速率限制**: 内置速率限制功能，防止网络拥塞
- **并发处理**: 多线程数据包发送和接收
- **去重处理**: 使用sync.Map和FNV哈希防止重复结果
- **跨平台支持**: 支持Windows和Linux，配合相应的pcap库
- **结果导出**: 将扫描结果保存到带时间戳的CSV文件

## 依赖库

本扫描器使用以下Go语言库：

### 核心库
- `github.com/google/gopacket` - 网络数据包处理
- `github.com/google/gopacket/layers` - 网络协议层定义
- `github.com/google/gopacket/pcap` - 数据包捕获功能
- `golang.org/x/time/rate` - 数据包传输速率限制
- `github.com/libp2p/go-netroute` - 网络路由信息获取

### 系统要求

#### Windows系统
**必需**: Npcap version 1.72 (基于 libpcap version 1.10.2-PRE-GIT)
- 下载地址: https://npcap.com/#download
- Npcap是Nmap项目的Windows数据包捕获库
- 提供WinPcap兼容性，具有增强的安全性和性能
- 支持Windows 7及更高版本

#### Linux系统
**必需**: libpcap库
- 下载地址: https://www.tcpdump.org/
- 通过包管理器安装:
  ```bash
  # Ubuntu/Debian
  sudo apt-get install libpcap-dev
  
  # CentOS/RHEL
  sudo yum install libpcap-devel
  
  # Arch Linux
  sudo pacman -S libpcap
  ```

## 安装步骤

1. **安装Go依赖**:
   ```bash
   go mod tidy
   ```

2. **安装平台特定的pcap库**（参见上述系统要求）

3. **编译扫描器**:
   ```bash
   go build -o syn_scanner syn_scan.go
   ```

## 使用方法

### 基本语法
```bash
./syn_scanner -ip <目标IP> -port <目标端口> [-rate <每秒数据包数>]
```

### 参数说明
- `-ip`: 目标IP地址或CIDR网段（必需）
  - 单个IP: `192.168.1.100`
  - CIDR网段: `192.168.1.0/24`
  - 多个目标: `192.168.1.1,192.168.1.2,10.0.0.0/16`
- `-port`: 目标端口号（必需）
- `-rate`: 数据包传输速率（可选，默认: 100包/秒）

### 使用示例

**扫描单个IP**:
```bash
./syn_scanner -ip 192.168.1.100 -port 80
```

**扫描CIDR网段**:
```bash
./syn_scanner -ip 192.168.1.0/24 -port 22
```

**自定义速率扫描**:
```bash
./syn_scanner -ip 10.0.0.0/16 -port 443 -rate 500
```

**扫描多个目标**:
```bash
./syn_scanner -ip "192.168.1.1,10.0.0.0/24" -port 3389
```

## SYN扫描流程

扫描器实现了异步TCP SYN扫描工作流程：

### 1. 初始化阶段
- 解析命令行参数并验证输入
- 如需要，将CIDR表示法解析为IP地址列表
- 随机打乱目标IP列表，避免被防火墙检测到规律
- 获取网络接口信息（MAC地址、网关）
- 初始化pcap句柄进行数据包捕获
- 创建速率限制器和序列号随机种子

### 2. 扫描阶段
- **并发架构**: 
  - 发送协程：构造并发送SYN数据包
  - 接收协程：捕获并处理SYN+ACK响应
- **数据包构造**:
  - 以太网层：包含源/目标MAC地址
  - IPv4层：包含源/目标IP地址
  - TCP层：设置SYN标志和唯一序列号
- **速率限制**: 使用令牌桶算法控制传输速度
- **序列号验证**: 使用带随机种子的Murmur3哈希进行数据包验证

### 3. 响应处理
- **数据包过滤**: 仅处理带有SYN+ACK标志的TCP数据包
- **序列验证**: 验证响应序列号与发送的数据包匹配
- **去重处理**: 
  - 使用sync.Map进行线程安全存储
  - 实现FNV哈希防止重复的IP:端口组合
- **结果记录**: 将开放端口保存到带时间戳的CSV文件

### 4. 关键算法
- **Murmur3哈希**: 生成用于数据包验证的唯一序列号
- **FNV哈希**: 为IP:端口组合创建指纹以防止重复
- **令牌桶速率限制**: 确保受控的数据包传输速率
- **并发映射操作**: 使用sync.Map进行线程安全的结果存储

## 输出结果

扫描结果保存为CSV文件，格式如下：
- 文件名: `scan_result_YYYY-MM-DD-HH-MM-SS.csv`
- 内容: 发现的开放端口的IP地址和端口号
- 控制台输出包括扫描统计信息和时间信息

## 性能考虑

- **内存使用**: 高效的数据包处理，最小化内存分配
- **CPU使用**: 通过协程实现多核利用
- **网络影响**: 速率限制防止网络拥塞
- **可扩展性**: 可以通过适当的速率设置处理大型CIDR网段

## 安全注意事项

- **管理员权限**: 需要提升权限才能访问原始数据包
- **防火墙考虑**: 可能在目标网络上触发安全警报
- **速率限制**: 使用适当的速率以避免被防火墙阻止
- **合规性**: 仅扫描您拥有或明确授权测试的网络

## 故障排除

### 常见问题
1. **权限被拒绝**: 使用管理员/root权限运行
2. **无网络接口**: 确保pcap库已正确安装
3. **CPU使用率高**: 降低`-rate`参数值
4. **无结果**: 检查防火墙设置和网络连接

### 调试信息
- 扫描器在启动时显示libpcap版本信息
- 初始化期间记录网络接口详细信息
- 完成时提供扫描统计信息

## 许可证

本项目按原样提供，用于教育和授权安全测试目的。
